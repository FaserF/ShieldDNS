name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: docker build -t shielddns:test .

      - name: Generate Self-Signed Certs for Testing
        run: |
          mkdir certs
          openssl req -x509 -newkey rsa:4096 -keyout certs/privkey.pem -out certs/fullchain.pem -days 365 -nodes -subj "/CN=localhost"

      - name: Start Container
        run: |
          docker run -d --name shielddns \
            -p 853:853 \
            -v $(pwd)/certs:/certs \
            -e UPSTREAM_DNS=8.8.8.8 \
            -e CERT_FILE=/certs/fullchain.pem \
            -e KEY_FILE=/certs/privkey.pem \
            shielddns:test

          sleep 5 # Give it a moment to start

      - name: Check Container Logs
        if: always()
        run: docker logs shielddns

      - name: Verify DNS Resolution (DoT)
        run: |
          # Install kdig (part of knot-utils in Ubuntu)
          sudo apt-get update && sudo apt-get install -y knot-dnsutils

          # Query localhost on port 853 using DoT
          # We disable cert verification (+tls-ca) because we used a self-signed cert
          kdig -d @127.0.0.1 -p 853 +tls-hostname=localhost +tls-ca=certs/fullchain.pem google.com

          # Explicit success check
          if kdig -d @127.0.0.1 -p 853 +tls-hostname=localhost +tls-ca=certs/fullchain.pem google.com | grep -q "NOERROR"; then
            echo "✅ DNS Resolution Successful"
          else
            echo "❌ DNS Resolution Failed"
            exit 1
          fi
